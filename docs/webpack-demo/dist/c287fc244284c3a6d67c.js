import{Buffer as r}from"buffer";import{EventEmitter as e}from"events";import{Pointers as t}from"./pointers.js";import n from"./expat.js";const s=await n();export class XmlParseError extends Error{constructor(r){const e=XmlParser.XML_GetErrorCode(r),t=XmlParser.XML_ErrorString(e);super(`XML Parse Error: "${t}"`),this.code=e,this.xmlMessage=t,this.line=XmlParser.XML_GetCurrentLineNumber(r),this.column=XmlParser.XML_GetCurrentColumnNumber(r),this.byteOffset=XmlParser.XML_GetCurrentByteIndex(r)}}export class XmlParser extends e{static#r=new t;static#e={};static#t={};static{this.#t=[["AttlistDecl",5,!1],["CharacterData",2,!1],["Comment",1,!0],["ElementDecl",2,!1],["EndCdataSection",0,!0],["EndDoctypeDecl",0,!0],["EndElement",1,!0],["EndNamespaceDecl",1,!0],["EntityDecl",8,!1],["NotationDecl",4,!0],["ProcessingInstruction",2,!0],["StartCdataSection",0,!0],["StartDoctypeDecl",4,!1],["StartElement",2,!1],["StartNamespaceDecl",2,!0],["XmlDecl",3,!1]].reduce(((r,[e,t,n])=>{const i=e[0].toLowerCase()+e.slice(1);return r[i]=s.cwrap(`XML_Set${e}Handler`,"void",["number","function"]),this.#e[i]=s.addFunction(this.#r.bind(n?"_simpleEvent":`_${i}`,i),"v".padEnd(t+2,"i")),r}),{})}static NO_NAMESPACES=Symbol("NO_NAMESPACES");static XML_ExpatVersion(){return s.ccall("XML_ExpatVersion","string")}static XML_FreeContentModel(r,e){s.ccall("XML_FreeContentModel","void",["number","number"],[r,e])}static XML_ParserCreate(r){return s.ccall("XML_ParserCreate","number",["string"],[r])}static XML_ParserCreateNS(r,e){return s.ccall("XML_ParserCreateNS","number",["string","number"],[r,e])}static XML_ParserFree(r){s.ccall("XML_ParserFree","void",["number"],[r])}static XML_Parse(r,e,t,n){return s.ccall("XML_Parse","void",["number","array","number","number"],[r,e,t,n])}static XML_SetReturnNSTriplet(r,e){s.ccall("XML_SetReturnNSTriplet","void",["number","number"],[r,e])}static XML_ParserReset(r,e){return s.ccall("XML_ParserReset","number",["number","string"],[r,e])}static XML_GetErrorCode(r){return s.ccall("XML_GetErrorCode","number",["number"],[r])}static XML_ErrorString(r){return s.ccall("XML_ErrorString","string",["number"],[r])}static XML_GetCurrentLineNumber(r){return s.ccall("XML_GetCurrentLineNumber","number",["number"],[r])}static XML_GetCurrentColumnNumber(r){return s.ccall("XML_GetCurrentColumnNumber","number",["number"],[r])}static XML_GetCurrentByteIndex(r){return s.ccall("XML_GetCurrentByteIndex","number",["number"],[r])}static XML_SetUserData(r,e){s.ccall("XML_SetUserData","void",["number","number"],[r,e])}constructor(r,e="|"){if(super(),this.separator=e,this.parser=(()=>{if("symbol"==typeof e)return e===XmlParser.NO_NAMESPACES?XmlParser.XML_ParserCreate(r):void 0;const t=XmlParser.XML_ParserCreateNS(r,e.charCodeAt(0));return XmlParser.XML_SetReturnNSTriplet(t,1),t})(),!this.parser)throw new Error("Unknown separator symbol");this.id=XmlParser.#r.add(this),XmlParser.XML_SetUserData(this.parser,this.id),this.xmlEncoding=r,this.encoding=r&&{"US-ASCII":"ascii","UTF-8":"utf8","UTF-16":"utf16le","ISO-8859-1":"latin1"}[r]||"utf8",this._registerHandlers()}_registerHandlers(){for(const[r,e]of Object.entries(XmlParser.#t))e(this.parser,XmlParser.#e[r])}emit(r,...e){const t=super.emit(r,...e);return super.emit("*",r,...e),t}_startElement(r,e,t){const n={};for(let r=t/4;s.HEAPU32[r];r+=2)n[s.UTF8ToString(s.HEAPU32[r])]=s.UTF8ToString(s.HEAPU32[r+1]);return this.emit(r,s.UTF8ToString(e),n)}_characterData(r,e,t){return this.emit(r,s.UTF8ToString(e,t))}_xmlDecl(r,e,t,n){return this.emit(r,s.UTF8ToString(e),s.UTF8ToString(t),Boolean(n))}_startDoctypeDecl(r,e,t,n,i){return this.emit(r,s.UTF8ToString(e),s.UTF8ToString(t),s.UTF8ToString(n),Boolean(i))}_unpackModel(r,e={}){const t=r/4,[n,i,a,o,l]=s.HEAPU32.slice(t,t+5);e.type=n,e.quant=i,a&&(e.name=s.UTF8ToString(a)),e.children=[];for(let r=0;r<o;r++)e.children.push(this._unpackModel(l+20*r));return e}_elementDecl(r,e,t){try{const n=s.UTF8ToString(e),i=this._unpackModel(t,{name:n});return this.emit(r,n,i)}finally{this.parser&&XmlParser.XML_FreeContentModel(this.parser,t)}}_attlistDecl(r,e,t,n,i,a){return this.emit(r,s.UTF8ToString(e),s.UTF8ToString(t),s.UTF8ToString(n),s.UTF8ToString(i),Boolean(a))}_entityDecl(r,e,t,n,i,a,o,l,c){return this.emit(r,s.UTF8ToString(e),Boolean(t),n?s.UTF8ToString(n,i):null,s.UTF8ToString(a),s.UTF8ToString(o),s.UTF8ToString(l),s.UTF8ToString(c))}_simpleEvent(r,...e){return this.emit(r,...e.map((r=>s.UTF8ToString(r))))}parse(e,t=1){if(!this.parser)throw new Error("Invalid state");"string"==typeof e&&(e=r.from(e,this.encoding));const n=e.length;if(r.isBuffer(e))e=new Uint8Array(e,0,n);else if(!(e instanceof Uint8Array||e instanceof Uint8ClampedArray))throw new Error("Expected chunk to be a string, Buffer, Uint8Array, or Uint8ClampedArray");const s=XmlParser.XML_Parse(this.parser,e,n,t);if(0===s){const r=new XmlParseError(this.parser);throw this.reset(),r}return 1===s&&1===t&&this.reset(),s}reset(){if(!this.parser)throw new Error("Invalid state");XmlParser.XML_ParserReset(this.parser,this.xmlEncoding),this._registerHandlers()}triple(r){if("string"!=typeof this.separator)throw new Error("Invalid separator");const[e,t,n]=r.split(this.separator);return t?n?{ns:e,local:t,prefix:n}:{ns:e,local:t}:{local:e}}destroy(){this.parser&&(XmlParser.XML_ParserFree(this.parser),delete this.parser),this.id&&(XmlParser.#r.remove(this.id),delete this.id)}}export default XmlParser;