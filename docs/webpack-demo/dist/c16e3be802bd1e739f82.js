import{Buffer as r}from"buffer";import{EventEmitter as t}from"events";import{Pointers as e}from"./pointers.js";import s from"./expat.js";const n=await s();export class XmlParseError extends Error{constructor(r,t=""){const e=XmlParser.XML_GetErrorCode(r),s=XmlParser.XML_ErrorString(e)+t;super(`XML Parse Error: "${s}"`),this.code=e,this.xmlMessage=s,this.line=XmlParser.XML_GetCurrentLineNumber(r),this.column=XmlParser.XML_GetCurrentColumnNumber(r),this.byteOffset=XmlParser.XML_GetCurrentByteIndex(r);const n=XmlParser.XML_GetBase(r);n&&(this.base=n)}}export class XmlParser extends t{static CHUNK_SIZE=4096;static#r=new e;static#t={};static#e={};static{this.#e=[["AttlistDecl",5,!1],["CharacterData",2,!1],["Comment",1,!0],["Default",2,!1],["ElementDecl",2,!1],["EndCdataSection",0,!0],["EndDoctypeDecl",0,!0],["EndElement",1,!0],["EndNamespaceDecl",1,!0],["EntityDecl",8,!1],["ExternalEntityRef",4,!1],["NotationDecl",4,!0],["ProcessingInstruction",2,!0],["StartCdataSection",0,!0],["StartDoctypeDecl",4,!1],["StartElement",2,!1],["StartNamespaceDecl",2,!0],["XmlDecl",3,!1]].reduce(((r,[t,e,s])=>{const i=t[0].toLowerCase()+t.slice(1);return r[i]=n.cwrap(`XML_Set${t}Handler`,"void",["number","function"]),this.#t[i]="externalEntityRef"===i?n.addFunction(XmlParser._externalEntityRefTrampoline.bind(XmlParser),"iiiiii"):n.addFunction(this.#r.bind(s?"_simpleEvent":`_${i}`,i),"v".padEnd(e+2,"i")),r}),{}),this.#e.defaultExpand=n.cwrap("XML_SetDefaultHandlerExpand","void",["number","function"])}static _externalEntityRefTrampoline(r,t,e,s,n){const i=XmlParser.XML_GetUserData(r);return this.#r.call("_externalEntityRef","externalEntityRef",i,r,t,e,s,n)}static NO_NAMESPACES=Symbol("NO_NAMESPACES");static XML_ExpatVersion(){return n.ccall("XML_ExpatVersion","string")}static XML_FreeContentModel(r,t){n.ccall("XML_FreeContentModel","void",["number","number"],[r,t])}static XML_ParserCreate(r){return n.ccall("XML_ParserCreate","number",["string"],[r])}static XML_ParserCreateNS(r,t){return n.ccall("XML_ParserCreateNS","number",["string","number"],[r,t])}static XML_ExternalEntityParserCreate(r,t,e){return n.ccall("XML_ExternalEntityParserCreate","number",["number","number","string"],[r,t,e])}static XML_ParserFree(r){n.ccall("XML_ParserFree","void",["number"],[r])}static XML_Parse(t,e,s,i){"string"==typeof e&&(e=r.from(e,i));const a=e.length;if(r.isBuffer(e))e=new Uint8Array(e,0,a);else if(!(e instanceof Uint8Array||e instanceof Uint8ClampedArray))throw new Error("Expected chunk to be a string, Buffer, Uint8Array, or Uint8ClampedArray");let o=0;for(let r=0;0===r||r<a;r+=this.CHUNK_SIZE){const i=e.slice(r,r+this.CHUNK_SIZE),l=Number(r+this.CHUNK_SIZE>=a);if(o=n.ccall("XML_Parse","void",["number","array","number","number"],[t,i,i.length,l&&s]),!o)return o}return o}static XML_SetBase(r,t){return n.ccall("XML_SetBase","number",["number","string"],[r,t])}static XML_GetBase(r){const t=n.ccall("XML_GetBase","number",["number"],[r]);return n.UTF8ToString(t)}static XML_SetReturnNSTriplet(r,t){n.ccall("XML_SetReturnNSTriplet","void",["number","number"],[r,t])}static XML_ParserReset(r,t){return n.ccall("XML_ParserReset","number",["number","string"],[r,t])}static XML_GetErrorCode(r){return n.ccall("XML_GetErrorCode","number",["number"],[r])}static XML_ErrorString(r){return n.ccall("XML_ErrorString","string",["number"],[r])}static XML_GetCurrentLineNumber(r){return n.ccall("XML_GetCurrentLineNumber","number",["number"],[r])}static XML_GetCurrentColumnNumber(r){return n.ccall("XML_GetCurrentColumnNumber","number",["number"],[r])}static XML_GetCurrentByteIndex(r){return n.ccall("XML_GetCurrentByteIndex","number",["number"],[r])}static XML_SetParamEntityParsing(r,t){return n.ccall("XML_SetParamEntityParsing","number",["number","number"],[r,t])}static XML_SetUserData(r,t){n.ccall("XML_SetUserData","void",["number","number"],[r,t])}static XML_GetUserData(r){return n.HEAPU32[r/4]}static XML_StopParser(r,t=0){return n.ccall("XML_StopParser","number",["number","number"],[r,t])}constructor(r,t="|"){if(super(),r&&"object"==typeof r||(r={encoding:r,separator:t}),this.opts={base:null,encoding:null,expandInternalEntities:!0,separator:"|",systemEntity:null,...r},this.separator=this.opts.separator,this.parser=(()=>{if("symbol"==typeof this.separator){if(this.separator===XmlParser.NO_NAMESPACES)return XmlParser.XML_ParserCreate(this.opts.encoding);throw new Error("Unknown separator symbol")}const r=XmlParser.XML_ParserCreateNS(this.opts.encoding,this.separator.charCodeAt(0));return XmlParser.XML_SetReturnNSTriplet(r,1),r})(),this.id=XmlParser.#r.add(this),XmlParser.XML_SetUserData(this.parser,this.id),this.opts.base){const r=typeof this.opts.base;if("string"!==r)throw new Error(`base option must be string, not ${r}`);if(1!==XmlParser.XML_SetBase(this.parser,this.opts.base))throw new Error("XML_SetBase failed")}this.xmlEncoding=this.opts.encoding,this.encoding=this.opts.encoding&&{"US-ASCII":"ascii","UTF-8":"utf8","UTF-16":"utf16le","ISO-8859-1":"latin1"}[this.opts.encoding]||"utf8",this.opts.systemEntity&&XmlParser.XML_SetParamEntityParsing(this.parser,1),this._registerHandlers()}_registerHandlers(){for(const[r,t]of Object.entries(XmlParser.#e))r.startsWith("default")||t(this.parser,XmlParser.#t[r]);this.opts.expandInternalEntities?XmlParser.#e.defaultExpand(this.parser,XmlParser.#t.default):XmlParser.#e.default(this.parser,XmlParser.#t.default)}emit(r,...t){const e=super.emit(r,...t);return super.emit("*",r,...t),e}_default(r,t,e){return this.emit(r,n.UTF8ToString(t,e))}_startElement(r,t,e){const s={};for(let r=e/4;n.HEAPU32[r];r+=2)s[n.UTF8ToString(n.HEAPU32[r])]=n.UTF8ToString(n.HEAPU32[r+1]);return this.emit(r,n.UTF8ToString(t),s)}_characterData(r,t,e){return this.emit(r,n.UTF8ToString(t,e))}_xmlDecl(r,t,e,s){return this.emit(r,n.UTF8ToString(t),n.UTF8ToString(e),Boolean(s))}_startDoctypeDecl(r,t,e,s,i){return this.emit(r,n.UTF8ToString(t),n.UTF8ToString(e),n.UTF8ToString(s),Boolean(i))}_unpackModel(r,t={}){const e=r/4,[s,i,a,o,l]=n.HEAPU32.slice(e,e+5);t.type=s,t.quant=i,a&&(t.name=n.UTF8ToString(a)),t.children=[];for(let r=0;r<o;r++)t.children.push(this._unpackModel(l+20*r));return t}_elementDecl(r,t,e){try{const s=n.UTF8ToString(t),i=this._unpackModel(e,{name:s});return this.emit(r,s,i)}finally{this.parser&&XmlParser.XML_FreeContentModel(this.parser,e)}}_attlistDecl(r,t,e,s,i,a){return this.emit(r,n.UTF8ToString(t),n.UTF8ToString(e),n.UTF8ToString(s),n.UTF8ToString(i),Boolean(a))}_entityDecl(r,t,e,s,i,a,o,l,c){return this.emit(r,n.UTF8ToString(t),Boolean(e),s?n.UTF8ToString(s,i):null,n.UTF8ToString(a),n.UTF8ToString(o),n.UTF8ToString(l),n.UTF8ToString(c))}_externalEntityRef(r,t,e,s,i,a){if("function"!=typeof this.opts.systemEntity)return 1;if(!this.parser)return 0;let o=null;try{o=this.opts.systemEntity(n.UTF8ToString(s),n.UTF8ToString(i),n.UTF8ToString(a))}catch(r){return this.emit("error",r),0}this.emit("startBase",o.base);const l=XmlParser.XML_ExternalEntityParserCreate(t,e,this.xmlEncoding);if(!l)return this.emit("error",new Error("Out of memory")),0;XmlParser.XML_SetBase(l,o.base);let c=1;return 1!==XmlParser.XML_Parse(l,o.data,1,this.encoding)&&(this.emit("error",new XmlParseError(l," in EntityRef")),c=0),XmlParser.XML_ParserFree(l),this.emit("endBase",o.base),c}_simpleEvent(r,...t){return this.emit(r,...t.map((r=>n.UTF8ToString(r))))}parse(r,t=1){if(!this.parser)throw new Error("Invalid state");const e=XmlParser.XML_Parse(this.parser,r,t,this.encoding);if(0===e){const r=new XmlParseError(this.parser);throw this.reset(),r}return 1===e&&1===t&&this.reset(),e}reset(){if(!this.parser)throw new Error("Invalid state");XmlParser.XML_ParserReset(this.parser,this.xmlEncoding),this._registerHandlers()}triple(r){if("string"!=typeof this.separator)throw new Error("Invalid separator");const[t,e,s]=r.split(this.separator);return e?s?{ns:t,local:e,prefix:s}:{ns:t,local:e}:{local:t}}stop(r=0){if(!this.parser)throw new Error("Invalid state");if(1!==XmlParser.XML_StopParser(this.parser,Number(r)))throw new Error("XML_StopParser failed")}destroy(){this.parser&&(XmlParser.XML_ParserFree(this.parser),delete this.parser),this.id&&(XmlParser.#r.remove(this.id),delete this.id)}}export default XmlParser;