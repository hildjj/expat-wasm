import{Buffer as t}from"buffer";import{EventEmitter as r}from"events";import{Pointers as e}from"./pointers.js";import s from"./expat.js";const n=await s();export class XmlParseError extends Error{constructor(t,r=""){const e=XmlParser.XML_GetErrorCode(t),s=XmlParser.XML_ErrorString(e)+r;super(`XML Parse Error: "${s}"`),this.code=e,this.xmlMessage=s,this.line=XmlParser.XML_GetCurrentLineNumber(t),this.column=XmlParser.XML_GetCurrentColumnNumber(t),this.byteOffset=XmlParser.XML_GetCurrentByteIndex(t);const n=XmlParser.XML_GetBase(t);n&&(this.base=n)}}export class XmlParser extends r{static CHUNK_SIZE=4096;static#t=new e;static#r={};static#e={};static{this.#e=[["AttlistDecl",5,!1],["CharacterData",2,!1],["Comment",1,!0],["Default",2,!1],["ElementDecl",2,!1],["EndCdataSection",0,!0],["EndDoctypeDecl",0,!0],["EndElement",1,!0],["EndNamespaceDecl",1,!0],["EntityDecl",8,!1],["ExternalEntityRef",4,!1],["NotationDecl",4,!0],["ProcessingInstruction",2,!0],["SkippedEntity",2,!1],["StartCdataSection",0,!0],["StartDoctypeDecl",4,!1],["StartElement",2,!1],["StartNamespaceDecl",2,!0],["XmlDecl",3,!1]].reduce(((t,[r,e,s])=>{const i=r[0].toLowerCase()+r.slice(1);return t[i]=n.cwrap(`XML_Set${r}Handler`,"void",["number","function"]),this.#r[i]="externalEntityRef"===i?n.addFunction(XmlParser._externalEntityRefTrampoline.bind(XmlParser),"iiiiii"):n.addFunction(this.#t.bind(s?"_simpleEvent":`_${i}`,i),"v".padEnd(e+2,"i")),t}),{}),this.#e.defaultExpand=n.cwrap("XML_SetDefaultHandlerExpand","void",["number","function"])}static _externalEntityRefTrampoline(t,r,e,s,n){const i=XmlParser.XML_GetUserData(t);return this.#t.call("_externalEntityRef","externalEntityRef",i,t,r,e,s,n)}static NO_NAMESPACES=Symbol("NO_NAMESPACES");static XML_ExpatVersion(){return n.ccall("XML_ExpatVersion","string")}static XML_FreeContentModel(t,r){n.ccall("XML_FreeContentModel","void",["number","number"],[t,r])}static XML_ParserCreate(t){return n.ccall("XML_ParserCreate","number",["string"],[t])}static XML_ParserCreateNS(t,r){return n.ccall("XML_ParserCreateNS","number",["string","number"],[t,r])}static XML_ExternalEntityParserCreate(t,r,e){return n.ccall("XML_ExternalEntityParserCreate","number",["number","number","string"],[t,r,e])}static XML_ParserFree(t){n.ccall("XML_ParserFree","void",["number"],[t])}static XML_Parse(r,e,s,i){"string"==typeof e&&(e=t.from(e,i));const a=e.length;if(t.isBuffer(e))e=new Uint8Array(e,0,a);else if(!(e instanceof Uint8Array||e instanceof Uint8ClampedArray))throw new Error("Expected chunk to be a string, Buffer, Uint8Array, or Uint8ClampedArray");let o=0;for(let t=0;0===t||t<a;t+=this.CHUNK_SIZE){const i=e.slice(t,t+this.CHUNK_SIZE),l=Number(t+this.CHUNK_SIZE>=a);if(o=n.ccall("XML_Parse","void",["number","array","number","number"],[r,i,i.length,l&&s]),!o)return o}return o}static XML_SetBase(t,r){return n.ccall("XML_SetBase","number",["number","string"],[t,r])}static XML_GetBase(t){const r=n.ccall("XML_GetBase","number",["number"],[t]);return n.UTF8ToString(r)}static XML_SetReturnNSTriplet(t,r){n.ccall("XML_SetReturnNSTriplet","void",["number","number"],[t,r])}static XML_ParserReset(t,r){return n.ccall("XML_ParserReset","number",["number","string"],[t,r])}static XML_GetErrorCode(t){return n.ccall("XML_GetErrorCode","number",["number"],[t])}static XML_ErrorString(t){return n.ccall("XML_ErrorString","string",["number"],[t])}static XML_GetCurrentLineNumber(t){return n.ccall("XML_GetCurrentLineNumber","number",["number"],[t])}static XML_GetCurrentColumnNumber(t){return n.ccall("XML_GetCurrentColumnNumber","number",["number"],[t])}static XML_GetCurrentByteIndex(t){return n.ccall("XML_GetCurrentByteIndex","number",["number"],[t])}static XML_SetParamEntityParsing(t,r){return n.ccall("XML_SetParamEntityParsing","number",["number","number"],[t,r])}static XML_SetUserData(t,r){n.ccall("XML_SetUserData","void",["number","number"],[t,r])}static XML_GetUserData(t){return n.HEAPU32[t/4]}static XML_StopParser(t,r=0){return n.ccall("XML_StopParser","number",["number","number"],[t,r])}constructor(t,r="|"){if(super(),t&&"object"==typeof t||(t={encoding:t,separator:r}),this.opts={base:null,encoding:null,expandInternalEntities:!0,separator:"|",systemEntity:null,...t},this.separator=this.opts.separator,this.parser=(()=>{if("symbol"==typeof this.separator){if(this.separator===XmlParser.NO_NAMESPACES)return XmlParser.XML_ParserCreate(this.opts.encoding);throw new Error("Unknown separator symbol")}const t=XmlParser.XML_ParserCreateNS(this.opts.encoding,this.separator.charCodeAt(0));return XmlParser.XML_SetReturnNSTriplet(t,1),t})(),this.id=XmlParser.#t.add(this),XmlParser.XML_SetUserData(this.parser,this.id),this.opts.base){const t=typeof this.opts.base;if("string"!==t)throw new Error(`base option must be string, not ${t}`);if(1!==XmlParser.XML_SetBase(this.parser,this.opts.base))throw new Error("XML_SetBase failed")}this.xmlEncoding=this.opts.encoding,this.encoding=this.opts.encoding&&{"US-ASCII":"ascii","UTF-8":"utf8","UTF-16":"utf16le","ISO-8859-1":"latin1"}[this.opts.encoding]||"utf8",this.opts.systemEntity&&XmlParser.XML_SetParamEntityParsing(this.parser,1),this._registerHandlers()}_registerHandlers(){for(const[t,r]of Object.entries(XmlParser.#e))t.startsWith("default")||r(this.parser,XmlParser.#r[t]);this.opts.expandInternalEntities?XmlParser.#e.defaultExpand(this.parser,XmlParser.#r.default):XmlParser.#e.default(this.parser,XmlParser.#r.default)}emit(t,...r){const e=super.emit(t,...r);return super.emit("*",t,...r),e}_default(t,r,e){return this.emit(t,n.UTF8ToString(r,e))}_skippedEntity(t,r,e){return this.emit(t,n.UTF8ToString(r),Boolean(e))}_startElement(t,r,e){const s={};for(let t=e/4;n.HEAPU32[t];t+=2)s[n.UTF8ToString(n.HEAPU32[t])]=n.UTF8ToString(n.HEAPU32[t+1]);return this.emit(t,n.UTF8ToString(r),s)}_characterData(t,r,e){return this.emit(t,n.UTF8ToString(r,e))}_xmlDecl(t,r,e,s){return this.emit(t,n.UTF8ToString(r),n.UTF8ToString(e),Boolean(s))}_startDoctypeDecl(t,r,e,s,i){return this.emit(t,n.UTF8ToString(r),n.UTF8ToString(e),n.UTF8ToString(s),Boolean(i))}_unpackModel(t,r={}){const e=t/4,[s,i,a,o,l]=n.HEAPU32.slice(e,e+5);r.type=s,r.quant=i,a&&(r.name=n.UTF8ToString(a)),r.children=[];for(let t=0;t<o;t++)r.children.push(this._unpackModel(l+20*t));return r}_elementDecl(t,r,e){try{const s=n.UTF8ToString(r),i=this._unpackModel(e,{name:s});return this.emit(t,s,i)}finally{this.parser&&XmlParser.XML_FreeContentModel(this.parser,e)}}_attlistDecl(t,r,e,s,i,a){return this.emit(t,n.UTF8ToString(r),n.UTF8ToString(e),n.UTF8ToString(s),n.UTF8ToString(i),Boolean(a))}_entityDecl(t,r,e,s,i,a,o,l,c){return this.emit(t,n.UTF8ToString(r),Boolean(e),s?n.UTF8ToString(s,i):null,n.UTF8ToString(a),n.UTF8ToString(o),n.UTF8ToString(l),n.UTF8ToString(c))}_externalEntityRef(t,r,e,s,i,a){if("function"!=typeof this.opts.systemEntity){if(e){const t=n.UTF8ToString(e).split("\f").find((t=>-1===t.indexOf("=")));this.emit("skippedEntity",t,!1)}return 1}if(!this.parser)return 0;let o=null;try{o=this.opts.systemEntity(n.UTF8ToString(s),n.UTF8ToString(i),n.UTF8ToString(a))}catch(t){return this.emit("error",t),0}this.emit("startBase",o.base);const l=XmlParser.XML_ExternalEntityParserCreate(r,e,this.xmlEncoding);if(!l)return this.emit("error",new Error("Out of memory")),0;XmlParser.XML_SetBase(l,o.base);let c=1;return 1!==XmlParser.XML_Parse(l,o.data,1,this.encoding)&&(this.emit("error",new XmlParseError(l," in EntityRef")),c=0),XmlParser.XML_ParserFree(l),this.emit("endBase",o.base),c}_simpleEvent(t,...r){return this.emit(t,...r.map((t=>n.UTF8ToString(t))))}parse(t,r=1){if(!this.parser)throw new Error("Invalid state");const e=XmlParser.XML_Parse(this.parser,t,r,this.encoding);if(0===e){const t=new XmlParseError(this.parser);throw this.reset(),t}return 1===e&&1===r&&this.reset(),e}reset(){if(!this.parser)throw new Error("Invalid state");XmlParser.XML_ParserReset(this.parser,this.xmlEncoding),this._registerHandlers()}triple(t){if("string"!=typeof this.separator)return{local:t};const[r,e,s]=t.split(this.separator);return e?s?{ns:r,local:e,prefix:s}:{ns:r,local:e}:{local:r}}stop(t=0){if(!this.parser)throw new Error("Invalid state");if(1!==XmlParser.XML_StopParser(this.parser,Number(t)))throw new Error("XML_StopParser failed")}destroy(){this.parser&&(XmlParser.XML_ParserFree(this.parser),delete this.parser),this.id&&(XmlParser.#t.remove(this.id),delete this.id)}}export default XmlParser;